How to limit transfer rate using HttpHandler
asp.net httphandler
I'm programming a file transfer handler with speed limit feature, the rate based on user level. How do I control/calculate transfer rate in HttpHandler?.
Some asp.net resource tell me that use Thread.Sleep will block asp.net thread pool.


You might want to try using timers and a timer callback to do this.  The idea would be to have a timer (or maybe two) that triggers when your handler can run and for how long.    Every time the "go" timer expires, it starts a thread which writes your data to the response until the "stop" timer expires (or the same timer expires again), then that thread finishes what it was doing, does the housekeeping for the next thread, resets the "go" timer, and exits.  Your main thread justs sets up the initial timer, the data for the transfer, then invokes the timer and exits.  Presumably you'd need to keep a handle to the response somewhere so that you could get access to it again.    By varying the length of time that the handler has to wait/execute you can control how many resources it uses.

It is generally a bad idea to Sleep any thread from ASP .NET, because those threads could be used otherwise to service requests from the pool. If there were say, 10 threads in the pool, sleeping 10 threads that were processing downloads would cause all other requests to pile up in the queue until a download had finished.
You are perhaps best served by creating an IHttpAsyncHandler instead of an IHttpHandler, as perscribed in:
http://msdn.microsoft.com/en-us/library/ms227433.aspx
You can use a timer to periodically pump x bytes of data to the client (but be sure to periodically pool for a closed connection using IsClientConnected or some such). 
